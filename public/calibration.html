<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Calibration</title>
    <link rel="stylesheet" href="milligram.min.css">
    <script src="cash.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
    <script src="//cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
</head>

<body style="font-size: 3em">
    <main class="wrapper">
        <section class="container">
            <h1>Calibration</h1>
            <p><a href="/settings.html">Back to settings</a></p>
            <form>
                <p><input id="enable" type="checkbox"> Enable calibration</p>
            </form>
            <p>This chart shows the raw sensor data. Use it to find suitable high/low thresholds.</p>
            <div class="ct-chart ct-minor-seventh"></div>
            <p>Raw values</p>
            <pre id="events"/>
        </section>
    </main>
</body>

<script>
var data = {
    labels: [],
    series: [
        []
    ]
};

var options = {
    showPoint: false,
    axisY: {
        type: Chartist.AutoScaleAxis,
        onlyInteger: true
    }
}

var chart = new Chartist.Line('.ct-chart', data, options);

var receivedEvents = 0;
var updateInterval = 4;
var conn = new WebSocket("ws://" + window.location.host + "/api/v1/raw.ws");
conn.onmessage = function (event) {
    console.log(event.data);

    let events = $("#events");
    events.text(events.text() + event.data)

    let json = JSON.parse(event.data)
    data.labels.push("");
    data.series[0].push(json["raw"])

    receivedEvents++;
    if (receivedEvents >= updateInterval) {
        chart.update(data)
        receivedEvents = 0;
    }
}
$('#enable').on('click', function(e, ...args) {
    let enabled = $(this).prop('checked');

    let xhr = new XMLHttpRequest();
    xhr.open('POST', '/api/v1/config.json');
    xhr.setRequestHeader("Content-type", "application/json");
    xhr.send(JSON.stringify({calibration: enabled}));
});
</script>
</html>
